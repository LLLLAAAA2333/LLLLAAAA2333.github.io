---
import type { MarkdownHeading } from 'astro'

interface Props {
  headings: MarkdownHeading[]
}

const { headings } = Astro.props

// 过滤掉过深的层级，只保留 h1, h2, h3 (根据需要调整)
const filteredHeadings = headings.filter((h) => h.depth <= 3)
---

<nav class="toc-container sticky top-20 max-h-[80vh] overflow-y-auto">
  <ul class="flex flex-col gap-2 text-sm">
    {
      filteredHeadings.map((heading) => (
        <li
          class:list={[
            'pl-2 border-l-2 border-transparent transition-colors duration-300',
            { 'pl-4': heading.depth === 3 }, // H3 缩进
          ]}
        >
          <a
            href={`#${heading.slug}`}
            class="toc-link block text-gray-500 hover:text-primary transition-colors"
            data-slug={heading.slug}
            data-no-swup
          >
            {heading.text}
          </a>
        </li>
      ))
    }
  </ul>
</nav>

<script is:inline>
  ;(() => {
    const observerOptions = {
      rootMargin: '-100px 0px -66% 0px',
    }

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        const id = entry.target.getAttribute('id')
        const link = document.querySelector(`.toc-link[data-slug="${id}"]`)

        if (entry.isIntersecting) {
          document.querySelectorAll('.toc-link').forEach((l) => {
            l.classList.remove('text-primary', 'font-bold')
            l.closest('li').classList.replace('border-primary', 'border-transparent')
          })

          if (link) {
            link.classList.add('text-primary', 'font-bold')
            link.closest('li').classList.replace('border-transparent', 'border-primary')
          }
        }
      })
    }, observerOptions)

    document.querySelectorAll('h1[id], h2[id], h3[id]').forEach((section) => {
      observer.observe(section)
    })

    document.querySelectorAll('.toc-link').forEach((link) => {
      link.addEventListener('click', (e) => {
        document.querySelectorAll('.toc-link').forEach((l) => {
          l.classList.remove('text-primary', 'font-bold')
          l.closest('li').classList.replace('border-primary', 'border-transparent')
        })
        const target = e.currentTarget
        target.classList.add('text-primary', 'font-bold')
        target.closest('li').classList.replace('border-transparent', 'border-primary')
      })
    })
  })()
</script>
